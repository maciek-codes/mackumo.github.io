<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Maciek Codes &#183; Maciek Codes</title>
<meta name=description content>
<meta name=generator content="Hugo 0.92.2">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Maciek Codes &#183; Maciek Codes">
<meta name=twitter:description content>
<meta property="og:type" content="article">
<meta property="og:title" content="Maciek Codes &#183; Maciek Codes">
<meta property="og:description" content>
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700" rel=stylesheet type=text/css>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css>
<link rel=stylesheet href=https://www.kumorek.com/css/all.min.css>
<link href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css rel=stylesheet>
<link rel=alternate type=application/rss+xml title="Maciek Codes" href=https://www.kumorek.com/index.xml>
</head>
<body>
<div id=layout class=pure-g>
<div class="sidebar pure-u-1 pure-u-md-1-4">
<div class=header>
<hgroup>
<h1 class=brand-title><a href=https://www.kumorek.com/>Maciek Codes</a></h1>
<h2 class=brand-tagline></h2>
</hgroup>
<nav class=nav>
<ul class=nav-list>
<li class=nav-item>
<a class=pure-button href=https://www.kumorek.com/index.xml>
<i class="fa fa-rss"></i> rss
</a>
</li>
</ul>
</nav>
</div>
</div>
<div class="content pure-u-1 pure-u-md-3-4">
<div>
<div class=posts>
<h1 class=content-subhead>17 Feb 2022, 22:16</h1>
<section class=post>
<header class=post-header>
<a href=https://www.kumorek.com/2022/02/a-case-of-datadog-apm-not-stiching-traces/ class=post-title>A case of Datadog APM not stiching traces</a>
<p class=post-meta>
</p>
</header>
<div class=post-description>
<p>Recently I worked on instrumenting a service with Datadog APM (Application Performance Monitoring). It&rsquo;s when I ran into an interesting issue that the StackOverflow didn&rsquo;t offer the usual obvious answer. After some digging, I&rsquo;m finally sharing my solution it here.</p>
<p>The problem was that sometimes traces produced by two services didn&rsquo;t get glued together by the Datadog backend. It appeared that APM traces with calls between &ldquo;Service A&rdquo; and &ldquo;Service B&rdquo; were correlated, but the same stitching didn&rsquo;t work when &ldquo;Service B&rdquo; made a call to &ldquo;Service A&rdquo;.</p>
<p>After some digging to find out what was wrong with my Datadog agent configuration, I realized that I needed to take a step back and ask &ldquo;How does Datadog correlate traces?&rdquo;.</p>
<p>In order for Datadog to stitch together two traces received from two different tracers (in my case - two agents running in two different services), the trace ID/parent trace ID have to match.</p>
<p>Datadog automatically injects the trace ID but it&rsquo;s not very well documented what is involved. At least not in Datadog&rsquo;s documentation.</p>
<p>Finally I found a useful page: <a href=https://docs.datadoghq.com/synthetics/apm/#how-are-traces-linked-to-tests>how are traces linked to tests</a>. Based on this article, I learned that the Datadog agent can automatically inject headers in outgoing HTTP calls.</p>
<p>I looked at the <a href=https://github.com/DataDog/dd-trace-java/blob/v0.95.1/dd-java-agent/instrumentation/opentelemetry/src/main/java/datadog/trace/instrumentation/opentelemetry/OtelContextPropagators.java>Java tracer source code</a> and learned that it actually follows <a href=https://opentelemetry.io/docs/>OpenTelemetry</a> convention for <a href=https://opentelemetry.lightstep.com/core-concepts/context-propagation/>context propagation</a>. The tracer agent, running within the same process as my Java application, intercepts any HTTP requests and sprinkles some extra headers to help corrlate the spans.</p>
<p>Why was the context propagation broken? Knowing that I should expect extra headers to show up in the calls made between the services, I was able to confirm that the headers were simply missing. In my particular case, this was due to the way nginx reverse proxy was configured for the &ldquo;Service A&rdquo;. The nginx.conf contained the following line:</p>
<pre tabindex=0><code>proxy_pass_request_headers off;
</code></pre><p>It means that the headers would not be passed to the upstream server unless explicitly requested with <code>proxy_set_header</code>. Therefore, the headers were missing by design.</p>
<p>From that the fix was easy. I added the following lines to nginx.conf:</p>
<pre tabindex=0><code>location / {
    # ...

    proxy_set_header x-datadog-trace-id $http_x_datadog_trace_id;
    proxy_set_header x-datadog-parent-id $http_x_datadog_parent_id;
    proxy_set_header x-datadog-sampling-priority $http_x_datadog_sampling_priority;
    proxy_set_header
    x-datadog-origin $http_x_datadog_origin;
    
    # ... 
}
</code></pre><p>And that worked! Traces are now auto-magically stitched together. Hope this helps someone solve their configuration problem a bit quicker.</p>
</div>
</section>
</div>
<div class=footer>
<div class="pure-menu pure-menu-horizontal pure-menu-open">
<ul>
<li>Powered by <a class=hugo href=https://gohugo.io/ target=_blank>hugo</a></li>
</ul>
</div>
</div>
<script src=https://www.kumorek.com/js/all.min.js></script>
</div>
</div>
</div>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','','auto'),ga('send','pageview')</script>
</body>
</html>